{% extends "/layout/admin_nav.html" %}

{% set active_page = "prospects" %}

{% block subhead %} Prospect Details {% endblock %}
{% block lead %} {{ prospect.email }} {% endblock %}

{% block content %}
<div class="row">
	<div class="span4">
		<h3>Contact</h3>
		{{ prospect.first_name }} {{ prospect.last_name }}
		<br>
		{{ prospect.email }}
		<br>
		{{ prospect.category }}
		<br>
		{{ prospect.language }}
		<br>
		<br>
		<br>
		<h3>Tags</h3>
		<form method="post" action="/admin/prospects/{{ prospect.prospect_id }}/tags"  id="prospect_tags_form">
			<div class="form-inline">
			{{ prospect_tags_form.tags(class='input-medium') }}
			</div>
			<button type="submit" class="btn btn-primary">
				{{ _('Update') }}
			</button>
		</form>
	</div>
	<div class="span4">
		<h3>GAE Geography</h3>
		Country: {{ prospect.gae_country }}
		<br>
		Region: {{ prospect.gae_region }}
		<br>
		City: {{ prospect.gae_city }}
		<br>
		<br>
		<br>
		<h3>Derived Info</h3>
	</div>
	<div class="span4">
		<h3>Prospect URLs</h3>
		{{ prospect.get_signup_url(host) }}
		<br>
		{{ prospect.get_tour_url(host) }}
		<br>
		{{ prospect.get_blog_url(host) }}
		<br>
		<br>
		<br>
		<h3>Campaign Info</h3>
	</div>
</div>

<div class="row">
	<br>
	<br>
	<div class="span12">
		<h3>Notes</h3>
		<table class="table table-striped">
			<thead>
				<th width="1%"></th>
				<th width="10%">Date and Time</th>
				<th width="10%">User</th>
				<th width="10%">Type</th>
				<th width="80%">Note</th>
			</thead>
			{% for note in prospect.get_notes() %}
			<tr>
				<td><a href="/admin/prospects/{{ prospect.prospect_id }}/notes/edit/{{ note.key.urlsafe() }}"><i class="bs-icon icon-edit"> </i></a></td>
				<td>{{ note.created_on|format_datetime(format="medium") }}</td>
				<td>{{ note.user }}</td>
				<td>{{ note.note_type }}</td>
				<td>{{ note.body|markdown|safe }}</td>
			</tr>
			{% endfor %}
		</table>
		<a data-toggle="modal" href="#note_modal" class="btn btn-primary">Add Note</a>
	</div>
</div>

<div class="row">
	<br>
	<br>
	<div class="span12">
		<h3>Site Logs</h3>
		<table class="table table-striped">
			<thead>
				<th>Date and Time</th>
				<th>Page</th>
				<th>Referer</th>
			</thead>
			{% if prospect %}
			{% for l in prospect.get_site_logs() %}
			<tr>
				<td>{{ l.access_time|format_datetime(format="medium") }}</td>
				<td>{{ l.page }}</td>
				<td>{{ l.referer }}</td>
			</tr>
			{% endfor %}
			{% endif %}
		</table>
	</div>
</div>

<div class="modal hide" id="note_modal" style="display: none;">
	<div class="modal-header">
		<a class="close" data-dismiss="modal">Ã—</a>

		<h3>Add Note</h3>
	</div>
	{% if edit == 'note' %}
	{% set post_url = '/admin/prospects/' + prospect.prospect_id + '/notes/edit/' + edit_key %}
	{% else %}
	{% set post_url = '/admin/prospects/' + prospect.prospect_id + '/notes/add' %}
	{% endif %}
	<form method="post" action="{{ post_url }}" class="form-horizontal" id="note_form">
		<div class="modal-body">
			{{ macro.make_standard_form(prospect_note_form) }}
		</div>

		<div class="modal-footer">
			{% if edit == 'note' %}
			<a class="btn btn-danger pull-left" href="/admin/prospects/{{ prospect.prospect_id }}/notes/delete/{{ edit_key }}"> {{ _('Delete') }} </a>
			{% endif %}

			<button type="submit" class="btn btn-primary">
				{{ _('Save') }}
			</button>
			<a class="btn" href="/admin/prospects/{{ prospect.prospect_id }}">{{ _('Cancel') }}</a>
		</div>
	</form>
</div>
{% endblock content %}

{% block extra_javascript %}

{% if edit == 'note' or prospect_note_form.errors %}
<script>
	$('#note_modal').modal('show')

	$('#note_modal').on('hidden', function() {
		window.location = "/admin/prospects/{{ prospect.prospect_id }}"
	})
</script>
{% endif %}

{% endblock %}

